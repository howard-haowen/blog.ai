<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Classifying customer reviews with spaCy v3.0 | Haowen’s AI blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Classifying customer reviews with spaCy v3.0" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post shows how to train models that can automatically identify the sentiment and product category of customer reviews. With the help of the recently released spaCy v3.0, text classification is an absolute breeze." />
<meta property="og:description" content="This post shows how to train models that can automatically identify the sentiment and product category of customer reviews. With the help of the recently released spaCy v3.0, text classification is an absolute breeze." />
<link rel="canonical" href="https://howard-haowen.github.io/blog.ai/spacy/text-classification/sentiment-analysis/customer-reviews/fasttext/facets/2021/03/12/Classifying-customer-reviews-with-spaCy-v3.html" />
<meta property="og:url" content="https://howard-haowen.github.io/blog.ai/spacy/text-classification/sentiment-analysis/customer-reviews/fasttext/facets/2021/03/12/Classifying-customer-reviews-with-spaCy-v3.html" />
<meta property="og:site_name" content="Haowen’s AI blog" />
<meta property="og:image" content="https://howard-haowen.github.io/blog.ai/images/classification.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-12T00:00:00-06:00" />
<script type="application/ld+json">
{"datePublished":"2021-03-12T00:00:00-06:00","url":"https://howard-haowen.github.io/blog.ai/spacy/text-classification/sentiment-analysis/customer-reviews/fasttext/facets/2021/03/12/Classifying-customer-reviews-with-spaCy-v3.html","@type":"BlogPosting","dateModified":"2021-03-12T00:00:00-06:00","image":"https://howard-haowen.github.io/blog.ai/images/classification.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://howard-haowen.github.io/blog.ai/spacy/text-classification/sentiment-analysis/customer-reviews/fasttext/facets/2021/03/12/Classifying-customer-reviews-with-spaCy-v3.html"},"headline":"Classifying customer reviews with spaCy v3.0","description":"This post shows how to train models that can automatically identify the sentiment and product category of customer reviews. With the help of the recently released spaCy v3.0, text classification is an absolute breeze.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog.ai/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://howard-haowen.github.io/blog.ai/feed.xml" title="Haowen's AI blog" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','G-46Y745KSM9','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/blog.ai/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog.ai/">Haowen&#39;s AI blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog.ai/about/">About Me</a><a class="page-link" href="/blog.ai/search/">Search</a><a class="page-link" href="/blog.ai/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Classifying customer reviews with spaCy v3.0</h1><p class="page-description">This post shows how to train models that can automatically identify the sentiment and product category of customer reviews. With the help of the recently released spaCy v3.0, text classification is an absolute breeze.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-03-12T00:00:00-06:00" itemprop="datePublished">
        Mar 12, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      28 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog.ai/categories/#spacy">spacy</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog.ai/categories/#text-classification">text-classification</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog.ai/categories/#sentiment-analysis">sentiment-analysis</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog.ai/categories/#customer-reviews">customer-reviews</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog.ai/categories/#fasttext">fasttext</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog.ai/categories/#facets">facets</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/howard-haowen/blog.ai/tree/master/_notebooks/2021-03-12-Classifying-customer-reviews-with-spaCy-v3.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog.ai/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/howard-haowen/blog.ai/master?filepath=_notebooks%2F2021-03-12-Classifying-customer-reviews-with-spaCy-v3.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog.ai/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/howard-haowen/blog.ai/blob/master/_notebooks/2021-03-12-Classifying-customer-reviews-with-spaCy-v3.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog.ai/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Intro">Intro </a></li>
<li class="toc-entry toc-h1"><a href="#Preparing-the-dataset">Preparing the dataset </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Getting-the-dataset">Getting the dataset </a></li>
<li class="toc-entry toc-h2"><a href="#Filtering-the-datases">Filtering the datases </a></li>
<li class="toc-entry toc-h2"><a href="#Converting-the-dataset-to-traditional-Chinese">Converting the dataset to traditional Chinese </a></li>
<li class="toc-entry toc-h2"><a href="#Inspecting-the-dataset">Inspecting the dataset </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Training-spaCy-models">Training spaCy models </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Instantiating-a-pretrained-spaCy-model">Instantiating a pretrained spaCy model </a></li>
<li class="toc-entry toc-h2"><a href="#Converting-the-dataset-to-spaCy-format-for-training">Converting the dataset to spaCy format for training </a></li>
<li class="toc-entry toc-h2"><a href="#Training-the-textcat-component-with-CLI">Training the textcat component with CLI </a></li>
<li class="toc-entry toc-h2"><a href="#Going-from-binary-to-multiclass-classification">Going from binary to multiclass classification </a></li>
<li class="toc-entry toc-h2"><a href="#Checking-model-performance">Checking model performance </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Recap">Recap </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-03-12-Classifying-customer-reviews-with-spaCy-v3.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://colab.research.google.com/github/howard-haowen/blog.ai/blob/master/_notebooks/2021-03-12-Classifying-customer-reviews-with-spaCy-v3.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://github.com/howard-haowen/blog.ai/raw/master/images/classification.png" alt="" title="Credit: www.sandraandwoo.com"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Intro">
<a class="anchor" href="#Intro" aria-hidden="true"><span class="octicon octicon-link"></span></a>Intro<a class="anchor-link" href="#Intro"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Text classification is a very common NLP task. Given enough training data, it's relatively easy to build a model that can automatically classify previously unseen texts in a way that follows the logic of the training data. In this post, I'll go through the steps for building such a model. Specifically, I'll leverage the power of the recently released spaCy v3.0 to train two classification models, one for identifying the sentiment of customer reviews in Chinese as being positive or negative (i.e. binary classification) and the other for predicting their product categories in a list of five (i.e. multiclass classification). If you can't wait to see how spaCy v3.0 has made the training process an absolute breeze, feel free to jump to the <code>training the textcat component with CLI</code> section. If not, bear with me on this long journey. All the datasets and models created in this post are hosted in <a href="https://github.com/howard-haowen/spaCy-text-classification">this repo</a> of mine.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Preparing-the-dataset">
<a class="anchor" href="#Preparing-the-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Preparing the dataset<a class="anchor-link" href="#Preparing-the-dataset"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Getting-the-dataset">
<a class="anchor" href="#Getting-the-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting the dataset<a class="anchor-link" href="#Getting-the-dataset"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I'm hoping to build classification models that can take traditional Chinese texts as input, but I can't find any publicly available datasets of customer reviews in traditional Chinese. So I had to make do with reviews in simplified Chinese. Let's first download the dataset using <code>!wget</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>wget https://raw.githubusercontent.com/SophonPlus/ChineseNlpCorpus/master/datasets/online_shopping_10_cats/online_shopping_10_cats.zip
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--2021-03-07 14:08:42--  https://raw.githubusercontent.com/SophonPlus/ChineseNlpCorpus/master/datasets/online_shopping_10_cats/online_shopping_10_cats.zip
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.108.133, 185.199.109.133, 185.199.110.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.108.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 4084428 (3.9M) [application/zip]
Saving to: ‘online_shopping_10_cats.zip’

online_shopping_10_ 100%[===================&gt;]   3.89M  --.-KB/s    in 0.1s    

2021-03-07 14:08:43 (37.1 MB/s) - ‘online_shopping_10_cats.zip’ saved [4084428/4084428]

</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we unzip the downloaded file <code>online_shopping_10_cats.zip</code> with, surprisingly, <code>!unzip</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>unzip online_shopping_10_cats.zip
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Archive:  online_shopping_10_cats.zip
  inflating: online_shopping_10_cats.csv  
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The dataset has three columns: <code>review</code> for review texts, <code>label</code> for sentiment , and <code>cat</code> for product categories. Here's a random sample of five reviews.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">file_path</span> <span class="o">=</span> <span class="s1">'/content/online_shopping_10_cats.csv'</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cat</th>
      <th>label</th>
      <th>review</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>35479</th>
      <td>洗发水</td>
      <td>0</td>
      <td>买了两套说好的赠品吹风机没给！</td>
    </tr>
    <tr>
      <th>35477</th>
      <td>洗发水</td>
      <td>0</td>
      <td>抢购降价一半？坑，爹？没赶上时候？</td>
    </tr>
    <tr>
      <th>53299</th>
      <td>酒店</td>
      <td>1</td>
      <td>碰上酒店做活动，加了40元给升级到行政房。房间还不错，比较新。服务员是实习生，不熟练但态度认...</td>
    </tr>
    <tr>
      <th>14367</th>
      <td>手机</td>
      <td>1</td>
      <td>1）外观新颖2）拥有强大的多媒体功能和卓越的性能，同时将电池的消耗减到最小，方便了更多的用户...</td>
    </tr>
    <tr>
      <th>12549</th>
      <td>平板</td>
      <td>0</td>
      <td>分辨率太低，买的后悔了.</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There're in total 62774 reviews.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(62774, 3)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>label</code> column has only two unique values, 1 for positive reviews and 0 for negative ones.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([1, 0])</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>cat</code> column has nine unique values.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array(['书籍', '平板', '手机', '水果', '洗发水', '热水器', '蒙牛', '衣服', '计算机', '酒店'],
      dtype=object)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Before moving on, let's save the raw dataset to Google Drive. The <code>dest</code> variable can be any GDrive path you like.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dest</span> <span class="o">=</span> <span class="s2">"/content/drive/MyDrive/Python/NLP/shopping_comments/"</span>
<span class="o">!</span>cp <span class="o">{</span>file_path<span class="o">}</span> <span class="o">{</span>dest<span class="o">}</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Filtering-the-datases">
<a class="anchor" href="#Filtering-the-datases" aria-hidden="true"><span class="octicon octicon-link"></span></a>Filtering the datases<a class="anchor-link" href="#Filtering-the-datases"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's do some data filtering. The <code>groupby</code> function from <code>pandas</code> is very useful, and here's how to get the counts of each of the unique values in the <code>cat</code> column.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'cat'</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>cat
书籍      3851
平板     10000
手机      2323
水果     10000
洗发水    10000
热水器      575
蒙牛      2033
衣服     10000
计算机     3992
酒店     10000
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To create a balanced dataset, I decided to keep categories whose counts are 10,000. So we're left with five product categories, 平板 for tablets, 水果 for fruits, 洗发水 for shampoo, 衣服 for clothing, and finally 酒店 for hotels.</p>
<p>There're many ways to filter data in <code>pandas</code>, and my favorite is to first create a <code>filt</code> variable that holds a list of <code>True</code> and <code>False</code>, which in this particular case is whether the value in the <code>cat</code> volumn is in the <code>cat_list</code> variable for the categories to be kept. Then we can simply filter data with <code>df[filt]</code>. After filtering, the dataset is reduced to 50,000 reviews.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'平板'</span><span class="p">,</span> <span class="s1">'水果'</span><span class="p">,</span> <span class="s1">'洗发水'</span><span class="p">,</span> <span class="s1">'衣服'</span><span class="p">,</span> <span class="s1">'酒店'</span><span class="p">]</span> 
<span class="n">filt</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'cat'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cat_list</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(50000, 3)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, the dataset is balanced in terms of both the <code>cat</code> and <code>label</code> columnn. There're 10,000 reviews for each product category.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'cat'</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>cat
平板     10000
水果     10000
洗发水    10000
衣服     10000
酒店     10000
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And there're 25,000 for either of the two sentiments.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'label'</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>label
0    25000
1    25000
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Having made sure the filtered dataset is balanced, we can now reset the index, and save the dataset as <code>online_shopping_5_cats_sim.csv</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dest</span><span class="o">+</span><span class="s2">"online_shopping_5_cats_sim.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Converting-the-dataset-to-traditional-Chinese">
<a class="anchor" href="#Converting-the-dataset-to-traditional-Chinese" aria-hidden="true"><span class="octicon octicon-link"></span></a>Converting the dataset to traditional Chinese<a class="anchor-link" href="#Converting-the-dataset-to-traditional-Chinese"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's load back the file we just saved to make sure the dataset is accessible for later use.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dest</span><span class="o">+</span><span class="s2">"online_shopping_5_cats_sim.csv"</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cat</th>
      <th>label</th>
      <th>review</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>49995</th>
      <td>酒店</td>
      <td>0</td>
      <td>我们去盐城的时候那里的最低气温只有4度，晚上冷得要死，居然还不开空调，投诉到酒店客房部，得到...</td>
    </tr>
    <tr>
      <th>49996</th>
      <td>酒店</td>
      <td>0</td>
      <td>房间很小，整体设施老化，和四星的差距很大。毛巾太破旧了。早餐很简陋。房间隔音很差，隔两间房间...</td>
    </tr>
    <tr>
      <th>49997</th>
      <td>酒店</td>
      <td>0</td>
      <td>我感觉不行。。。性价比很差。不知道是银川都这样还是怎么的！</td>
    </tr>
    <tr>
      <th>49998</th>
      <td>酒店</td>
      <td>0</td>
      <td>房间时间长，进去有点异味！服务员是不是不够用啊！我在一楼找了半个小时以上才找到自己房间，想找...</td>
    </tr>
    <tr>
      <th>49999</th>
      <td>酒店</td>
      <td>0</td>
      <td>老人小孩一大家族聚会，选在吴宫泛太平洋，以为新加坡品牌一定很不错，没想到11点30分到前台，...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, I converted the reviews from simplified Chinese to traditional Chinese using the <code>OpenCC</code> library.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install OpenCC
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting OpenCC
  Downloading https://files.pythonhosted.org/packages/d5/b4/24e677e135df130fc6989929dc3990a1ae19948daf28beb8f910b4f7b671/OpenCC-1.1.1.post1-py2.py3-none-manylinux1_x86_64.whl (1.3MB)
     |████████████████████████████████| 1.3MB 8.0MB/s 
Installing collected packages: OpenCC
Successfully installed OpenCC-1.1.1.post1
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>OpenCC</code> has many conversion methods. I specifically used <code>s2twp</code>, which converts simplified Chinese to traditional Chinese adpated to Taiwanese vocabulary. The adaptation is not optimal, but it's better than mechanic simplified-to-traditional conversion. Here's a random review in the two writing systems.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">opencc</span> <span class="kn">import</span> <span class="n">OpenCC</span>
<span class="n">cc</span> <span class="o">=</span> <span class="n">OpenCC</span><span class="p">(</span><span class="s1">'s2twp'</span><span class="p">)</span> 
<span class="n">test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">49995</span><span class="p">,</span> <span class="s1">'review'</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="n">test_tra</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_tra</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>我们去盐城的时候那里的最低气温只有4度，晚上冷得要死，居然还不开空调，投诉到酒店客房部，得到的答复是现在还没有领导指示需要开暖气，如果冷到话可以多给一床被子，太可怜了。。。
我們去鹽城的時候那裡的最低氣溫只有4度，晚上冷得要死，居然還不開空調，投訴到酒店客房部，得到的答覆是現在還沒有領導指示需要開暖氣，如果冷到話可以多給一床被子，太可憐了。。。
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Having made sure the conversion is correct, we can now go ahead and convert all reviews.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="s1">'review'</span><span class="p">]</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'review'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cc</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's make the same change to the <code>cat</code> column.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="s1">'cat'</span><span class="p">]</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'cat'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cc</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And then we save the converted dataset as <code>online_shopping_5_cats_tra.csv</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dest</span><span class="o">+</span><span class="s1">'online_shopping_5_cats_tra.csv'</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inspecting-the-dataset">
<a class="anchor" href="#Inspecting-the-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Inspecting the dataset<a class="anchor-link" href="#Inspecting-the-dataset"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's load back the file just saved to make sure it's accessible in the future.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dest</span><span class="o">+</span><span class="s1">'online_shopping_5_cats_tra.csv'</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cat</th>
      <th>label</th>
      <th>review</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>49995</th>
      <td>酒店</td>
      <td>0</td>
      <td>我們去鹽城的時候那裡的最低氣溫只有4度，晚上冷得要死，居然還不開空調，投訴到酒店客房部，得到...</td>
    </tr>
    <tr>
      <th>49996</th>
      <td>酒店</td>
      <td>0</td>
      <td>房間很小，整體設施老化，和四星的差距很大。毛巾太破舊了。早餐很簡陋。房間隔音很差，隔兩間房間...</td>
    </tr>
    <tr>
      <th>49997</th>
      <td>酒店</td>
      <td>0</td>
      <td>我感覺不行。。。價效比很差。不知道是銀川都這樣還是怎麼的！</td>
    </tr>
    <tr>
      <th>49998</th>
      <td>酒店</td>
      <td>0</td>
      <td>房間時間長，進去有點異味！服務員是不是不夠用啊！我在一樓找了半個小時以上才找到自己房間，想找...</td>
    </tr>
    <tr>
      <th>49999</th>
      <td>酒店</td>
      <td>0</td>
      <td>老人小孩一大家族聚會，選在吳宮泛太平洋，以為新加坡品牌一定很不錯，沒想到11點30分到前臺，...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Before building models, I would normally inspect the dataset. There're many ways to do so. I recently learned that there's a trick on Colab which allows you to filter a dataset in an interactive manner. All it takes is three lines of code.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> google.colab.data_table
<span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">data_table</span>
<span class="n">data_table</span><span class="o">.</span><span class="n">DataTable</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">include_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_rows_per_page</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Alternatively, if you'd like to see some sample reviews from all the categories, the <code>groupby</code> function is quite handy. The trick here is to feed <code>pd.DataFrame.sample</code> to the <code>apply</code> function so that you can specify the number of reviews to inspect from each product category.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'cat'</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)[[</span><span class="s1">'label'</span><span class="p">,</span> <span class="s1">'review'</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>label</th>
      <th>review</th>
    </tr>
    <tr>
      <th>cat</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">平板</th>
      <th>6247</th>
      <td>0</td>
      <td>這個平板真的是3G的嗎？你們有沒有忽悠唉，為什麼我下了一個百度影片，就卡的要死要活的，跟我以...</td>
    </tr>
    <tr>
      <th>1081</th>
      <td>1</td>
      <td>看網頁玩王者榮耀都很流暢，音質畫面都不錯，就是稍微重了點，綜合性價比還是很好的</td>
    </tr>
    <tr>
      <th>1042</th>
      <td>1</td>
      <td>我覺得還可以，就是把膜貼上了之後，有點滑不動，打遊戲的時候就很煩了</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">水果</th>
      <th>10468</th>
      <td>1</td>
      <td>還不錯，這個價格比我在外面買的划算，以後還會經常來，個頭不是很大，還可以吧</td>
    </tr>
    <tr>
      <th>10986</th>
      <td>1</td>
      <td>蘋果味道好，就是小了一點，比想象的要小量了一下，好像基本上都沒到70毫米。快遞還是挺快的包裝...</td>
    </tr>
    <tr>
      <th>18062</th>
      <td>0</td>
      <td>這是我在京東消費這麼多年來買到唯一次最爛的東西，還是自營一斤6塊錢的就這貨色還有一個是壞的，...</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">洗髮水</th>
      <th>23271</th>
      <td>1</td>
      <td>很好，很舒服，清揚就是好用，謝謝老闆，希望一直好用，好好好好好好好好好，快樂</td>
    </tr>
    <tr>
      <th>21992</th>
      <td>1</td>
      <td>一如既往的好 京東速度快 值得信賴 優惠多多</td>
    </tr>
    <tr>
      <th>21867</th>
      <td>1</td>
      <td>京東購物 多快好省 寫評論真的很累 有木有 每次商品很滿意就用這個 各位大佬請放心購買</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">衣服</th>
      <th>30157</th>
      <td>1</td>
      <td>褲子質量不錯，貨真價實，和店家介紹的基本相符，大小合適，樣式也很滿意，穿上褲子走路感到很輕便，舒服</td>
    </tr>
    <tr>
      <th>33190</th>
      <td>1</td>
      <td>做工精細穿起來很舒服，質量很好</td>
    </tr>
    <tr>
      <th>35326</th>
      <td>0</td>
      <td>質量很差，沒有想象的那麼好</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">酒店</th>
      <th>42243</th>
      <td>1</td>
      <td>房間是新裝修的,用的是淺色調,感覺很溫馨,佈局較合理,顯的比較寬敞.酒店選用的布草很講究,放...</td>
    </tr>
    <tr>
      <th>48082</th>
      <td>0</td>
      <td>實在忍無可忍。1、水。缺水現象——洗澡至中途，突然斷水，望著滿身的肥皂泡欲哭無淚；多水現象—...</td>
    </tr>
    <tr>
      <th>49552</th>
      <td>0</td>
      <td>下雨天冷，想洗熱水澡，可惜開了半小時水還是冷的</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, one of the most powerful ways of exploring a dataset is to use the <code>facets-overview</code> library. Let's first create a column for the length of review texts.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">'len'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'review'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cat</th>
      <th>label</th>
      <th>review</th>
      <th>len</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>49995</th>
      <td>酒店</td>
      <td>0</td>
      <td>我們去鹽城的時候那裡的最低氣溫只有4度，晚上冷得要死，居然還不開空調，投訴到酒店客房部，得到...</td>
      <td>86</td>
    </tr>
    <tr>
      <th>49996</th>
      <td>酒店</td>
      <td>0</td>
      <td>房間很小，整體設施老化，和四星的差距很大。毛巾太破舊了。早餐很簡陋。房間隔音很差，隔兩間房間...</td>
      <td>102</td>
    </tr>
    <tr>
      <th>49997</th>
      <td>酒店</td>
      <td>0</td>
      <td>我感覺不行。。。價效比很差。不知道是銀川都這樣還是怎麼的！</td>
      <td>29</td>
    </tr>
    <tr>
      <th>49998</th>
      <td>酒店</td>
      <td>0</td>
      <td>房間時間長，進去有點異味！服務員是不是不夠用啊！我在一樓找了半個小時以上才找到自己房間，想找...</td>
      <td>64</td>
    </tr>
    <tr>
      <th>49999</th>
      <td>酒店</td>
      <td>0</td>
      <td>老人小孩一大家族聚會，選在吳宮泛太平洋，以為新加坡品牌一定很不錯，沒想到11點30分到前臺，...</td>
      <td>455</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we install the library.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install facets-overview
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting facets-overview
  Downloading https://files.pythonhosted.org/packages/df/8a/0042de5450dbd9e7e0773de93fe84c999b5b078b1f60b4c19ac76b5dd889/facets_overview-1.0.0-py2.py3-none-any.whl
Requirement already satisfied: protobuf&gt;=3.7.0 in /usr/local/lib/python3.7/dist-packages (from facets-overview) (3.12.4)
Requirement already satisfied: pandas&gt;=0.22.0 in /usr/local/lib/python3.7/dist-packages (from facets-overview) (1.1.5)
Requirement already satisfied: numpy&gt;=1.16.0 in /usr/local/lib/python3.7/dist-packages (from facets-overview) (1.19.5)
Requirement already satisfied: six&gt;=1.9 in /usr/local/lib/python3.7/dist-packages (from protobuf&gt;=3.7.0-&gt;facets-overview) (1.15.0)
Requirement already satisfied: setuptools in /usr/local/lib/python3.7/dist-packages (from protobuf&gt;=3.7.0-&gt;facets-overview) (53.0.0)
Requirement already satisfied: python-dateutil&gt;=2.7.3 in /usr/local/lib/python3.7/dist-packages (from pandas&gt;=0.22.0-&gt;facets-overview) (2.8.1)
Requirement already satisfied: pytz&gt;=2017.2 in /usr/local/lib/python3.7/dist-packages (from pandas&gt;=0.22.0-&gt;facets-overview) (2018.9)
Installing collected packages: facets-overview
Successfully installed facets-overview-1.0.0
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to render an interative visualization of the dataset, we first convert the DataFrame object <code>df</code> to the json format and then add it to an HTML template, as shown below. If you choose <code>len</code> for <code>Binning | X-Axis</code>, <code>cat</code> for <code>Binning | Y-Axis</code>, and finally <code>review</code> for <code>Label By</code>, you'll see all the reviews are beautifully arranged in term of text length along the X axis and product categories along the Y axis. They're also color-coded with respect to sentiment, blue for positive and red for negative. Clicking on a point of either color shows the values of that particular datapoint. Feel free to play around.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">jsonstr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">'records'</span><span class="p">)</span>
<span class="n">HTML_TEMPLATE</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">        &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/1.3.3/webcomponents-lite.js"&gt;&lt;/script&gt;</span>
<span class="s2">        &lt;link rel="import" href="https://raw.githubusercontent.com/PAIR-code/facets/1.0.0/facets-dist/facets-jupyter.html"&gt;</span>
<span class="s2">        &lt;facets-dive id="elem" height="600"&gt;&lt;/facets-dive&gt;</span>
<span class="s2">        &lt;script&gt;</span>
<span class="s2">          var data = </span><span class="si">{jsonstr}</span><span class="s2">;</span>
<span class="s2">          document.querySelector("#elem").data = data;</span>
<span class="s2">        &lt;/script&gt;"""</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">HTML_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jsonstr</span><span class="o">=</span><span class="n">jsonstr</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Training-spaCy-models">
<a class="anchor" href="#Training-spaCy-models" aria-hidden="true"><span class="octicon octicon-link"></span></a>Training spaCy models<a class="anchor-link" href="#Training-spaCy-models"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Instantiating-a-pretrained-spaCy-model">
<a class="anchor" href="#Instantiating-a-pretrained-spaCy-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Instantiating a pretrained spaCy model<a class="anchor-link" href="#Instantiating-a-pretrained-spaCy-model"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>spaCy supports many pretrained models in multiple languages, and offers a convenient <a href="https://spacy.io/models">widget</a> for working out the code for downloading a particular model for a particular language. I specifically picked <code>zh_core_web_md</code> for Chinese.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install -U pip setuptools wheel
<span class="o">!</span>pip install -U spacy
<span class="o">!</span>python -m spacy download zh_core_web_md
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Everthing in spaCy starts with loading a model. The model we downloaded has five built-in components, accessible via the <code>pipe_names</code> attribute.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">spacy</span>
<span class="n">nlp</span><span class="o">=</span><span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"zh_core_web_md"</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">pipe_names</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['tok2vec', 'tagger', 'parser', 'ner', 'attribute_ruler']</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's call the <code>nlp</code> object with a sample review text and print out its tokens to make sure the model is working.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="s1">'review'</span><span class="p">]</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">pos_</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>買 VERB
了 PART
送人 NOUN
的 PART
， PUNCT
沒有 VERB
拆開 NOUN
， PUNCT
包裝 VERB
高大上 NOUN
， PUNCT
以前 NOUN
自用 VERB
買 VERB
了 PART
一 NUM
個 NUM
， PUNCT
這次 ADJ
活動 NOUN
便宜 VERB
好 VERB
幾百 VERB
， PUNCT
價格 NOUN
好 ADV
划算 VERB
啊 PART
， PUNCT
以後 NOUN
還會 VERB
降價 NOUN
嗎 VERB
？？？ PUNCT
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Converting-the-dataset-to-spaCy-format-for-training">
<a class="anchor" href="#Converting-the-dataset-to-spaCy-format-for-training" aria-hidden="true"><span class="octicon octicon-link"></span></a>Converting the dataset to spaCy format for training<a class="anchor-link" href="#Converting-the-dataset-to-spaCy-format-for-training"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To train a classification model wtih spaCy, we have to convert our dataset to spaCy format. Before that, we'll create a directory called <code>data</code> under the current working directory <code>cwd</code>. This is where we'll save the data in spaCy format.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash flash-success">
    <svg class="octicon octicon-checklist octicon octicon-checklist octicon octicon-checklist octicon octicon-checklist octicon octicon-checklist" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M2.5 1.75a.25.25 0 01.25-.25h8.5a.25.25 0 01.25.25v7.736a.75.75 0 101.5 0V1.75A1.75 1.75 0 0011.25 0h-8.5A1.75 1.75 0 001 1.75v11.5c0 .966.784 1.75 1.75 1.75h3.17a.75.75 0 000-1.5H2.75a.25.25 0 01-.25-.25V1.75zM4.75 4a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-4.5zM4 7.75A.75.75 0 014.75 7h2a.75.75 0 010 1.5h-2A.75.75 0 014 7.75zm11.774 3.537a.75.75 0 00-1.048-1.074L10.7 14.145 9.281 12.72a.75.75 0 00-1.062 1.058l1.943 1.95a.75.75 0 001.055.008l4.557-4.45z"></path></svg>
    <strong>Tip: </strong>I find the <code>os.makedirs</code> function much more useful than the more commonly seen <code>os.mkdir()</code> function because the former creates all the intermediate directories for you if they don’t exist yet.  
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">def</span> <span class="nf">create_dir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
  <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
  <span class="n">project_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>  
  <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">project_dir</span><span class="p">)</span>  
  <span class="k">return</span> <span class="n">project_dir</span>

<span class="n">project_dir</span> <span class="o">=</span> <span class="n">create_dir</span><span class="p">(</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">project_dir</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'/content/data'</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first step for the conversion is to create a list of tuples with two elements, one for the text and the other for the text class label. Let's start with the binary classification for sentiment first and generalize to multiclass classification for product categories later.</p>
<p>The easiest way to generate such a list is to create a new column called <code>tuples</code> (or whatever), whose values are derived by applying a <code>lambda</code> function to <code>review</code> for text and <code>label</code> for text class. I learned this trick from this <a href="https://www.machinelearningplus.com/nlp/custom-text-classification-spacy/">article</a>. Here're the first 10 tuples in the newly created <code>dataset</code> list.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">'tuples'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'review'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'label'</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'tuples'</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">dataset</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[('\ufeff很不錯。。。。。。很好的平板', 1),
 ('幫同學買的，同學說感覺挺好，質量也不錯', 1),
 ('東西不錯，一看就是正品包裝，還沒有開機，相信京東，都是老顧客，還是京東值得信賴，給五星好評', 1),
 ('總體而言，產品還是不錯的。', 1),
 ('好，不錯，真的很好不錯', 1),
 ('很好，音響效果不錯。挺喜歡的，用了一段時間才來評價的。', 1),
 ('包裝不是很好，裡面太空了我不塞多點汽泡袋，其它的還可以', 1),
 ('之前一直用華為手機，覺得不錯，想試一下平板，前天下單，昨天到貨，試了一下，感覺還不錯，家裡也有ipad，兩者不能比較，各有各的好，只是近年一直都用華為，手機，盒子用起來都不錯，現在是老媽用蘋果手機用ipad，我都用華為，用習慣了。大小也正合適，挺喜歡的，唯一欠缺的一點就是沒有耳機。後面多用幾次再追評吧。',
  1),
 ('說實話，非常喜歡，這個是送給客戶的，之前送的蘋果派的，但是不能拷檔案，自從找到這款，物美價廉，經濟實惠，很喜歡！！！買了好幾個了', 1),
 ('續航能力也太差了吧，看影片1個小時就25%了', 1)]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then I split the <code>dataset</code> using <code>train_test_split</code> from <code>scikit-learn</code>. The <code>train_data</code> and <code>valid_data</code> hold 80% and 20% of the <code>dataset</code>, respectively.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">valid_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we need to turn the <code>dataset</code> list into spaCy <code>Doc</code> objects and assign text classes to each of them so that the model can start learning. Assigning text classes is the trickiest part and took me lots of trials and errors to figure out. Unfortunately, official documentation of spaCy is not very clear about this part. At first, I used this <code>make_docs</code> function from <a href="https://github.com/p-sodmann/Spacy3Textcat/blob/main/create_data.py">p-sodmann/Spacy3Textcat</a> to create <code>Doc</code> objects. That was successful, but the trained model gave weird results. Then I realized that the values of text classes need to be either <code>True</code> or <code>False</code>. So here's my revised version of the <code>make_docs</code> function. The trick here is to use <code>bool(label)</code>, which will be <code>True</code> if the value of the label is 1 and <code>False</code> if its value is 0.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">spacy.tokens</span> <span class="kn">import</span> <span class="n">DocBin</span>

<span class="k">def</span> <span class="nf">make_docs</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    this will take a list of texts and labels and transform them in spacy documents</span>
<span class="sd">    </span>
<span class="sd">    texts: List(str)</span>
<span class="sd">    labels: List(labels)</span>
<span class="sd">    </span>
<span class="sd">    returns: List(spacy.Doc.doc)</span>
<span class="sd">    """</span>
    
    <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># nlp.pipe([texts]) is way faster than running nlp(text) for each text</span>
    <span class="c1"># as_tuples allows us to pass in a tuple, the first one is treated as text</span>
    <span class="c1"># the second one will get returned as it is.</span>
    
    <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">nlp</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">as_tuples</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        
        <span class="c1"># we need to set the (text)cat(egory) for each document</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">cats</span><span class="p">[</span><span class="s2">"POSITIVE"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">cats</span><span class="p">[</span><span class="s2">"NEGATIVE"</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># put them into a nice list</span>
        <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">docs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>spaCy v3.0 introduces the <code>DocBin</code> class, which is the recommended container for serializing a list of <code>Doc</code> objects, much like the pickle format, but better. After we create a list of <code>Doc</code> objects with the <code>make_docs</code> function, we can then generate an instance of the <code>DocBin</code> class for holding that list and save the serialized object to disk by calling the <code>to_disk</code> function. We first do this to <code>valid_data</code> and save the serialized file as <code>valid.spacy</code> in the <code>data</code> directory.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">valid_docs</span> <span class="o">=</span> <span class="n">make_docs</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
<span class="n">doc_bin</span> <span class="o">=</span> <span class="n">DocBin</span><span class="p">(</span><span class="n">docs</span><span class="o">=</span><span class="n">valid_docs</span><span class="p">)</span>
<span class="n">doc_bin</span><span class="o">.</span><span class="n">to_disk</span><span class="p">(</span><span class="s2">"./data/valid.spacy"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we do the same thing to <code>train_data</code> and save it as <code>train.spacy</code>. This will take much more time to run since <code>train_data</code> is much larger than <code>valid_data</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_docs</span> <span class="o">=</span> <span class="n">make_docs</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">doc_bin</span> <span class="o">=</span> <span class="n">DocBin</span><span class="p">(</span><span class="n">docs</span><span class="o">=</span><span class="n">train_docs</span><span class="p">)</span>
<span class="n">doc_bin</span><span class="o">.</span><span class="n">to_disk</span><span class="p">(</span><span class="s2">"./data/train.spacy"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And that was the end of the converting process! Now I'd like to save the serialized data for later use, so I copied it to <code>dest</code>, which is a directory in my Google Drive.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>Remember to use the <code>-R</code> flag when copying whatever in a directory to another. 
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="s2">"/content/data"</span>
<span class="n">dest</span> <span class="o">=</span> <span class="s2">"/content/drive/MyDrive/Python/NLP/shopping_comments/spaCy-sentiment-model/"</span>
<span class="o">!</span>cp -R <span class="o">{</span>source<span class="o">}</span> <span class="o">{</span>dest<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training-the-textcat-component-with-CLI">
<a class="anchor" href="#Training-the-textcat-component-with-CLI" aria-hidden="true"><span class="octicon octicon-link"></span></a>Training the textcat component with CLI<a class="anchor-link" href="#Training-the-textcat-component-with-CLI"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>spaCy v3.0 offers a nice and easy way to train spaCy's <code>textcat</code> component with a command line interfact (CLI). The first step is to get the <code>base_config.cfg</code> file, which is generated for you if you use spaCy's <a href="https://spacy.io/usage/training#quickstart">quickstart widget</a>. The only thing that needs to changed is <code>train</code> and <code>dev</code> under <code>[paths]</code>, which indicate where the serialized files are stored.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> base_config.cfg

<span class="c1"># This is an auto-generated partial config. To use it with 'spacy train'</span>
<span class="c1"># you can run spacy init fill-config to auto-fill all default settings:</span>
<span class="c1"># python -m spacy init fill-config ./base_config.cfg ./config.cfg</span>
<span class="p">[</span><span class="n">paths</span><span class="p">]</span>
<span class="n">train</span> <span class="o">=</span> <span class="s2">"data/train.spacy"</span>
<span class="n">dev</span> <span class="o">=</span> <span class="s2">"data/valid.spacy"</span>

<span class="p">[</span><span class="n">system</span><span class="p">]</span>
<span class="n">gpu_allocator</span> <span class="o">=</span> <span class="n">null</span>

<span class="p">[</span><span class="n">nlp</span><span class="p">]</span>
<span class="n">lang</span> <span class="o">=</span> <span class="s2">"zh"</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"tok2vec"</span><span class="p">,</span><span class="s2">"textcat"</span><span class="p">]</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="p">[</span><span class="n">components</span><span class="p">]</span>

<span class="p">[</span><span class="n">components</span><span class="o">.</span><span class="n">tok2vec</span><span class="p">]</span>
<span class="n">factory</span> <span class="o">=</span> <span class="s2">"tok2vec"</span>

<span class="p">[</span><span class="n">components</span><span class="o">.</span><span class="n">tok2vec</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
<span class="nd">@architectures</span> <span class="o">=</span> <span class="s2">"spacy.Tok2Vec.v2"</span>

<span class="p">[</span><span class="n">components</span><span class="o">.</span><span class="n">tok2vec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embed</span><span class="p">]</span>
<span class="nd">@architectures</span> <span class="o">=</span> <span class="s2">"spacy.MultiHashEmbed.v1"</span>
<span class="n">width</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="n">components</span><span class="o">.</span><span class="n">tok2vec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="o">.</span><span class="n">width</span><span class="p">}</span>
<span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ORTH"</span><span class="p">,</span> <span class="s2">"SHAPE"</span><span class="p">]</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">2500</span><span class="p">]</span>
<span class="n">include_static_vectors</span> <span class="o">=</span> <span class="n">false</span>

<span class="p">[</span><span class="n">components</span><span class="o">.</span><span class="n">tok2vec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">]</span>
<span class="nd">@architectures</span> <span class="o">=</span> <span class="s2">"spacy.MaxoutWindowEncoder.v2"</span>
<span class="n">width</span> <span class="o">=</span> <span class="mi">96</span>
<span class="n">depth</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">maxout_pieces</span> <span class="o">=</span> <span class="mi">3</span>

<span class="p">[</span><span class="n">components</span><span class="o">.</span><span class="n">textcat</span><span class="p">]</span>
<span class="n">factory</span> <span class="o">=</span> <span class="s2">"textcat"</span>

<span class="p">[</span><span class="n">components</span><span class="o">.</span><span class="n">textcat</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
<span class="nd">@architectures</span> <span class="o">=</span> <span class="s2">"spacy.TextCatBOW.v1"</span>
<span class="n">exclusive_classes</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">ngram_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">no_output_layer</span> <span class="o">=</span> <span class="n">false</span>

<span class="p">[</span><span class="n">corpora</span><span class="p">]</span>

<span class="p">[</span><span class="n">corpora</span><span class="o">.</span><span class="n">train</span><span class="p">]</span>
<span class="nd">@readers</span> <span class="o">=</span> <span class="s2">"spacy.Corpus.v1"</span>
<span class="n">path</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="n">paths</span><span class="o">.</span><span class="n">train</span><span class="p">}</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="mi">2000</span>

<span class="p">[</span><span class="n">corpora</span><span class="o">.</span><span class="n">dev</span><span class="p">]</span>
<span class="nd">@readers</span> <span class="o">=</span> <span class="s2">"spacy.Corpus.v1"</span>
<span class="n">path</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="n">paths</span><span class="o">.</span><span class="n">dev</span><span class="p">}</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="mi">0</span>

<span class="p">[</span><span class="n">training</span><span class="p">]</span>
<span class="n">dev_corpus</span> <span class="o">=</span> <span class="s2">"corpora.dev"</span>
<span class="n">train_corpus</span> <span class="o">=</span> <span class="s2">"corpora.train"</span>

<span class="p">[</span><span class="n">training</span><span class="o">.</span><span class="n">optimizer</span><span class="p">]</span>
<span class="nd">@optimizers</span> <span class="o">=</span> <span class="s2">"Adam.v1"</span>

<span class="p">[</span><span class="n">training</span><span class="o">.</span><span class="n">batcher</span><span class="p">]</span>
<span class="nd">@batchers</span> <span class="o">=</span> <span class="s2">"spacy.batch_by_words.v1"</span>
<span class="n">discard_oversize</span> <span class="o">=</span> <span class="n">false</span>
<span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="p">[</span><span class="n">training</span><span class="o">.</span><span class="n">batcher</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
<span class="nd">@schedules</span> <span class="o">=</span> <span class="s2">"compounding.v1"</span>
<span class="n">start</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">stop</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">compound</span> <span class="o">=</span> <span class="mf">1.001</span>

<span class="p">[</span><span class="n">initialize</span><span class="p">]</span>
<span class="n">vectors</span> <span class="o">=</span> <span class="n">null</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Writing base_config.cfg
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we create the <code>config.cfg</code> configuration file with <code>base_config.cfg</code> by using this command.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python -m spacy init fill-config ./base_config.cfg ./config.cfg
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2021-03-05 01:43:52.105583: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.11.0
<span class="ansi-green-fg">✔ Auto-filled config with all values</span>
<span class="ansi-green-fg">✔ Saved config</span>
config.cfg
You can now add your data and train your pipeline:
python -m spacy train config.cfg --paths.train ./train.spacy --paths.dev ./dev.spacy
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here comes the fun part, where we can see how a computer model learns over time! The initial score was 43, which is worse than chance. But only after 200 iterations, the score already skyrocketed to 83! By the end of the training, we got a score of 92, which is pretty awesome, considering that we didn't do any text preprocessing.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python -m spacy train ./config.cfg --output ./output
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2021-03-05 01:44:00.345586: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.11.0
<span class="ansi-green-fg">✔ Created output directory: output</span>
<span class="ansi-blue-fg">ℹ Using CPU</span>
<span class="ansi-bold">
=========================== Initializing pipeline ===========================</span>
Set up nlp object from config
Pipeline: ['tok2vec', 'textcat']
Created vocabulary
Finished initializing nlp object
Initialized pipeline components: ['tok2vec', 'textcat']
<span class="ansi-green-fg">✔ Initialized pipeline</span>
<span class="ansi-bold">
============================= Training pipeline =============================</span>
<span class="ansi-blue-fg">ℹ Pipeline: ['tok2vec', 'textcat']</span>
<span class="ansi-blue-fg">ℹ Initial learn rate: 0.001</span>
E    #       LOSS TOK2VEC  LOSS TEXTCAT  CATS_SCORE  SCORE 
---  ------  ------------  ------------  ----------  ------
  0       0          0.00          0.06       43.32    0.43
  0     200          0.00         34.18       83.25    0.83
  0     400          0.00         21.43       86.60    0.87
  0     600          0.00         12.77       87.25    0.87
  0     800          0.00         15.29       89.00    0.89
  0    1000          0.00         11.78       89.71    0.90
  0    1200          0.00          5.92       89.62    0.90
  0    1400          0.00          4.52       89.98    0.90
  0    1600          0.00          1.51       90.40    0.90
  0    1800          0.00          4.41       90.82    0.91
  0    2000          0.00          0.80       90.76    0.91
  0    2200          0.00          1.53       90.97    0.91
  0    2400          0.00          0.16       91.06    0.91
  0    2600          0.00          0.37       91.34    0.91
  0    2800          0.00          0.13       91.33    0.91
  0    3000          0.00          0.16       91.40    0.91
  0    3200          0.00          0.20       91.56    0.92
  0    3400          0.00          0.38       91.57    0.92
  0    3600          0.00          0.10       91.70    0.92
  1    3800          0.00          0.12       91.41    0.91
  1    4000          0.00          0.17       91.65    0.92
  1    4200          0.00          0.10       91.54    0.92
  1    4400          0.00          0.14       91.58    0.92
  1    4600          0.00          0.15       91.58    0.92
  1    4800          0.00          0.19       91.59    0.92
  1    5000          0.00          0.09       91.66    0.92
  1    5200          0.00          2.16       91.91    0.92
  1    5400          0.00          0.12       91.86    0.92
  1    5600          0.00          0.21       91.68    0.92
  1    5800          0.00          0.10       91.69    0.92
  2    6000          0.00          2.18       91.22    0.91
  2    6200          0.00          0.15       91.50    0.92
  2    6400          0.00          0.16       91.61    0.92
  2    6600          0.00          0.10       91.67    0.92
  2    6800          0.00          0.11       91.57    0.92
<span class="ansi-green-fg">✔ Saved pipeline to output directory</span>
output/model-last
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>spaCy automatically saves two models to the path specified by the <code>--output</code> argument. We'll use the best model for testing. Here's the py file adapted from <a href="https://github.com/p-sodmann/Spacy3Textcat/blob/main/create_data.py">p-sodmann/Spacy3Textcat</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> test_input.py
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="c1"># load the best model from training</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"output/model-best"</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"type : 'quit' to exit"</span><span class="p">)</span>
<span class="c1"># predict the sentiment until someone writes quit</span>
<span class="k">while</span> <span class="n">text</span> <span class="o">!=</span> <span class="s2">"quit"</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"Please enter a review here: "</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">cats</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Writing test_input.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> test_input.py
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="c1"># load the best model from training</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"/content/drive/MyDrive/Python/NLP/shopping_comments/spaCy-text-classification/spaCy-sentiment-model/model-best"</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"type : 'quit' to exit"</span><span class="p">)</span>
<span class="c1"># predict the sentiment until someone writes quit</span>
<span class="k">while</span> <span class="n">text</span> <span class="o">!=</span> <span class="s2">"quit"</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"Please enter a review here: "</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">cats</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Writing test_input.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's print out some reviews in <code>valid_data</code> for the sake of testing the model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">valid_data</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[('和以前買的不一樣！以前用的特別滑！用的也少！這次買的不僅用的東西多！而且還頭皮癢！有頭屑！', 0),
 ('不好意思我貨未收到，我想起訴你們！', 0),
 ('寶貝收到了，是我想要的版型，質量十分好，這條褲子的顏色跟圖片上一樣，是我想要的顏色，總之，是一次很愉快的購物', 1),
 ('一點也不甜不清脆，只能榨汁了。', 0),
 ('蘋果小，但味道不錯，給個好評吧', 1),
 ('平板收到，很滿意和想像的一樣，沒失望第一時間體驗中，稍後再評', 1),
 ('說好的樂視會員一年 送哪去了 差評', 0),
 ('相當完美啊 好東西', 1),
 ('連生產生日都沒有，真不知道是不是真的。', 0),
 ('蘋果一如既往得好，脆、甜、水分足，推薦購買哦奧～', 1)]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's run <code>test_input.py</code> to start grilling the model about the sentiment of reviews. The results are quite satisfactory. I even intentionally asked about a mixed review, 他們家的香蕉好吃，但是蘋果卻一點也不甜! (Their bananas are delicious, but their apples are not sweet at all!). And the model gave almost equal scores to the two sentiments!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python test_input.py
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2021-03-05 05:16:18.092297: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.11.0
type : 'quit' to exit
Please enter a review here: 和以前買的不一樣！以前用的特別滑！用的也少！這次買的不僅用的東西多！而且還頭皮癢！有頭屑！
{'POSITIVE': 0.022647695615887642, 'NEGATIVE': 0.9773523211479187}
Please enter a review here: 平板收到，很滿意和想像的一樣，沒失望第一時間體驗中，稍後再評
{'POSITIVE': 0.43043994903564453, 'NEGATIVE': 0.5695600509643555}
Please enter a review here: 說好的樂視會員一年 送哪去了 差評
{'POSITIVE': 0.20790322124958038, 'NEGATIVE': 0.792096734046936}
Please enter a review here: 連生產生日都沒有，真不知道是不是真的。
{'POSITIVE': 0.04043734818696976, 'NEGATIVE': 0.9595626592636108}
Please enter a review here: 蘋果一如既往得好，脆、甜、水分足，推薦購買哦奧～
{'POSITIVE': 0.9967644214630127, 'NEGATIVE': 0.0032355356961488724}
Please enter a review here: 他們家的香蕉好吃，但是
{'POSITIVE': 0.7071358561515808, 'NEGATIVE': 0.2928641438484192}
Please enter a review here: 他們家的香蕉好吃，但是蘋果卻一點也不甜!
{'POSITIVE': 0.5702691674232483, 'NEGATIVE': 0.4297308325767517}
Please enter a review here: quit
{'POSITIVE': 0.46642377972602844, 'NEGATIVE': 0.533576250076294}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, I saved the best trained model to Google Drive.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="s2">"/content/output/model-best"</span>
<span class="n">dest</span> <span class="o">=</span> <span class="s2">"/content/drive/MyDrive/Python/NLP/shopping_comments/spaCy-sentiment-model/"</span>
<span class="o">!</span>cp -R <span class="o">{</span>source<span class="o">}</span> <span class="o">{</span>dest<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Going-from-binary-to-multiclass-classification">
<a class="anchor" href="#Going-from-binary-to-multiclass-classification" aria-hidden="true"><span class="octicon octicon-link"></span></a>Going from binary to multiclass classification<a class="anchor-link" href="#Going-from-binary-to-multiclass-classification"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we'll go over pretty much the same steps to train a multiclass classification model. This time, the <code>dataset</code> is a list of tuples with review texts and product categories.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">'tuples'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'review'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'cat'</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'tuples'</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">dataset</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[('非常一般的酒店，房裡設施很舊，房間送餐竟然要加多50%的送餐費。總之找不到好的方面來說，有其他選擇就不要去了', '酒店'),
 ('房間沒窗戶，攜程網竟然沒有說明！', '酒店'),
 ('1、中午快一點到店，說房間沒有收拾出來，只好寄存行李出去玩，晚上回到房間滿屋煙味，打電話後給調了同型房間。明知道入住的是一家三口親子游，還這樣安排，初始印象分-1 2、電視很多頻道都是雪花，調了幾個臺都是如此，一點看電視的興致都沒了，-0.5毫不過分 3、房間設施一點不人性化，先說燈，除了總控，還要開燈具開關，晚上起夜，前前後後摁了五六個開關才把燈開啟，一點睡意都沒了，-0.5不冤吧；再說洗澡，浴缸很淺，站在裡面淋浴完後外面地上全是水，只能墊個浴巾之類的跳到房間穿衣，還好我和娃她媽還沒老到跳不動。第二天晚上一家三口沒一個人有洗澡的興致，這個-1算客氣了吧 4、最後來說早餐，剛進去服務員一把攔住，娃身高超一米二，要全價一百九，雖然肉痛，一想五星級飯店早餐應該值這個價，就去付了，一個男領班模樣的帶到一邊，讓付九十現金就可以了。付完了還竊喜佔了便宜，等端了盤子找吃的時才發現品種少的可憐。娃之前在四星都能吃到的冰激淋這根本找不到。還沒吃完娃就和我們嘟噥，明天打死也不來吃。-1算理智了吧 5、我要這麼給您減完了，您估計會以為我挑剔，故意找碴。這麼來說吧，稍微讓我們滿意的就是空調溫度了，還有禮賓部寄存行李的服務員了。讓我暫時忘卻你們是五星級飯店吧，這裡給您+0.5 6、沒有比較就沒有差距，遠的不說，這次來北京住五晚，前兩天是紅杉假日酒店，我給評了4.8，和您比起來，除了地段外，您就沒哪項能落了好的。人家酒店剛入住時也說了小孩半價早餐，可覺得過年早餐品種不夠豐富，就免了娃的費用。諷刺的是，我們一家尤其是娃覺得紅杉的早餐比您這要豐盛可口，唯一遺憾的是那也沒冰淇淋。 7、您要是就憑地段就能拉紅杉一晚三百的差距，您自個也覺得心安理得。那我提醒您一句：且行且珍惜',
  '酒店'),
 ('酒店很舊 房間很小。入住體驗非常不好。服務還可以。下面是盤門景區，這點不錯。到各景區交通比較方便。', '酒店'),
 ('開始以為應該不錯，結果大失所望！！頂多跟100塊的小旅館差不多！各種設施都老舊的要命！連淋雨花灑壞的！最坑的是網速還限制每個房間幾百K!!開個網頁都要五分鐘好嗎？真破酒店！',
  '酒店'),
 ('我們去鹽城的時候那裡的最低氣溫只有4度，晚上冷得要死，居然還不開空調，投訴到酒店客房部，得到的答覆是現在還沒有領導指示需要開暖氣，如果冷到話可以多給一床被子，太可憐了。。。',
  '酒店'),
 ('房間很小，整體設施老化，和四星的差距很大。毛巾太破舊了。早餐很簡陋。房間隔音很差，隔兩間房間的聲音都聽得見。晚上有人在走廊裡大聲喧譁很久，也沒有人來勸止。比不上以前入住的附近的經濟型酒店。下次不會入住了。',
  '酒店'),
 ('我感覺不行。。。價效比很差。不知道是銀川都這樣還是怎麼的！', '酒店'),
 ('房間時間長，進去有點異味！服務員是不是不夠用啊！我在一樓找了半個小時以上才找到自己房間，想找個服務員問一下都找不到，總之不推薦！', '酒店'),
 ('老人小孩一大家族聚會，選在吳宮泛太平洋，以為新加坡品牌一定很不錯，沒想到11點30分到前臺，大堂裡擠滿了人，我們所有人都託著大大的行李箱站著，還有的抱著小嬰兒，排隊辦理入住，足足等了1個多小時，期間還被前臺張悅（自稱是當天的值班經理，和另一位自稱值班經理有重複，不知誰是誰非）冷嘲熱諷，總之等待的客人都很不高興，前臺速度太慢，一會兒進裡面問問，一會兒去那裡問問，很混亂的感覺！我們的房間等到4點還沒拿到房！ 房間裡的床品有發黴潮溼的味道，絕對不像5星級，家人們都說不如3星的！ 排隊吃早飯排了半小時，也算是醉了，而且沒什麼東西吃，問有沒有小餛飩，煎荷包蛋的廚師說有，但要點單45元一碗，沒聽說過自助餐廳裡有收費的專案，要麼說沒有，再說一碗小餛飩要45元？邊上聽著的客人直搖頭！ 沒辦法承接這麼多客流，就不要接，入住體驗很不好！勸上海的朋友不要被宣傳圖片和文字忽悠了，起碼旺季真心不咋的，出入不方便，電梯不是直達的，必須經過前臺才能到底，總之體驗非常差，每次去蘇州都住園區那裡，老城區第一次體驗，不好，不會再去！',
  '酒店')]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the <code>make_doc</code> function above, we hardcoded the string names of text classes, that is, <code>POSITIVE</code> and <code>NEGATIVE</code>. That was not a good option since the function cannot be reused in other cases. So I'd like a general function that works just as well even if we don't know in advance how many  text classes there are in the dataset and what their string names are. After doing some experiments, I finally came up with the <code>make_docs_multiclass</code> function, which does the job. The trick here is to create the <code>label_dict</code> dictionary with every unique class name as keys and <code>False</code> as their default values for every <code>Doc</code> object in the for-loop. Then we assign <code>label_dict</code> to the <code>cats</code> attribute of every <code>Doc</code> object, that is, <code>doc.cats = label_dict</code>. At last, we update the value of a class in <code>label_dict</code> to <code>True</code> only when that is the class of the <code>Doc</code> object in question.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">unique_labels</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">make_docs_multiclass</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    this will take a list of texts and labels and transform them in spacy documents</span>
<span class="sd">    </span>
<span class="sd">    texts: List(str)</span>
<span class="sd">    labels: List(labels)</span>
<span class="sd">    </span>
<span class="sd">    returns: List(spacy.Doc.doc)</span>
<span class="sd">    """</span>
    
    <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># nlp.pipe([texts]) is way faster than running nlp(text) for each text</span>
    <span class="c1"># as_tuples allows us to pass in a tuple, the first one is treated as text</span>
    <span class="c1"># the second one will get returned as it is.</span>
    
    <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">nlp</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">as_tuples</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">label_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">}</span>
        <span class="c1"># we need to set the (text)cat(egory) for each document</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">cats</span> <span class="o">=</span> <span class="n">label_dict</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">cats</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># put them into a nice list</span>
        <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">docs</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we split the dataset, convert it to sapCy format, save the converted data, and train a model with CLI, just like we did earlier.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">valid_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">valid_docs</span> <span class="o">=</span> <span class="n">make_docs_multiclass</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
<span class="n">doc_bin</span> <span class="o">=</span> <span class="n">DocBin</span><span class="p">(</span><span class="n">docs</span><span class="o">=</span><span class="n">valid_docs</span><span class="p">)</span>
<span class="n">doc_bin</span><span class="o">.</span><span class="n">to_disk</span><span class="p">(</span><span class="s2">"./data/valid.spacy"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_docs</span> <span class="o">=</span> <span class="n">make_docs_multiclass</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">doc_bin</span> <span class="o">=</span> <span class="n">DocBin</span><span class="p">(</span><span class="n">docs</span><span class="o">=</span><span class="n">train_docs</span><span class="p">)</span>
<span class="n">doc_bin</span><span class="o">.</span><span class="n">to_disk</span><span class="p">(</span><span class="s2">"./data/train.spacy"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="s2">"/content/data"</span>
<span class="n">dest</span> <span class="o">=</span> <span class="s2">"/content/drive/MyDrive/Python/NLP/shopping_comments/spaCy-product-cat-model/"</span>
<span class="o">!</span>cp -R <span class="o">{</span>source<span class="o">}</span> <span class="o">{</span>dest<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>After training, we got an overall score of 89, which is pretty awesome.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python -m spacy train ./config.cfg --output ./output-multiclass
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2021-03-05 03:12:00.200786: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.11.0
<span class="ansi-green-fg">✔ Created output directory: output-multiclass</span>
<span class="ansi-blue-fg">ℹ Using CPU</span>
<span class="ansi-bold">
=========================== Initializing pipeline ===========================</span>
Set up nlp object from config
Pipeline: ['tok2vec', 'textcat']
Created vocabulary
Finished initializing nlp object
Initialized pipeline components: ['tok2vec', 'textcat']
<span class="ansi-green-fg">✔ Initialized pipeline</span>
<span class="ansi-bold">
============================= Training pipeline =============================</span>
<span class="ansi-blue-fg">ℹ Pipeline: ['tok2vec', 'textcat']</span>
<span class="ansi-blue-fg">ℹ Initial learn rate: 0.001</span>
E    #       LOSS TOK2VEC  LOSS TEXTCAT  CATS_SCORE  SCORE 
---  ------  ------------  ------------  ----------  ------
  0       0          0.00          0.09        0.00    0.00
  0     200          0.00         45.82       37.83    0.38
  0     400          0.00         14.59       63.48    0.63
  0     600          0.00         12.88       71.83    0.72
  0     800          0.00         12.18       76.29    0.76
  0    1000          0.00          5.34       78.87    0.79
  0    1200          0.00          3.11       80.73    0.81
  0    1400          0.00          4.12       82.13    0.82
  0    1600          0.00          1.41       82.99    0.83
  0    1800          0.00          0.76       83.86    0.84
  0    2000          0.00          0.58       84.57    0.85
  0    2200          0.00          0.40       85.13    0.85
  0    2400          0.00          0.22       85.54    0.86
  0    2600          0.00          0.24       86.10    0.86
  0    2800          0.00          0.17       86.51    0.87
  0    3000          0.00          0.30       86.82    0.87
  0    3200          0.00          0.20       87.06    0.87
  0    3400          0.00          0.26       87.13    0.87
  0    3600          0.00          0.14       87.48    0.87
  1    3800          0.00          0.13       87.73    0.88
  1    4000          0.00          0.13       87.80    0.88
  1    4200          0.00          0.31       87.80    0.88
  1    4400          0.00          0.12       88.07    0.88
  1    4600          0.00          0.25       88.07    0.88
  1    4800          0.00          0.26       87.97    0.88
  1    5000          0.00          0.10       88.25    0.88
  1    5200          0.00          0.20       88.27    0.88
  1    5400          0.00          0.15       88.39    0.88
  1    5600          0.00          0.13       88.51    0.89
  1    5800          0.00          0.11       88.53    0.89
  2    6000          0.00          0.16       88.77    0.89
  2    6200          0.00          0.15       88.39    0.88
  2    6400          0.00          0.15       88.67    0.89
  2    6600          0.00          0.11       88.77    0.89
  2    6800          0.00          0.11       88.65    0.89
  2    7000          0.00          0.14       88.73    0.89
  2    7200          0.00          0.11       88.69    0.89
  2    7400          0.00          0.17       88.67    0.89
  2    7600          0.00          0.17       88.58    0.89
  2    7800          0.00          0.11       88.68    0.89
  2    8000          0.00          0.28       88.96    0.89
  3    8200          0.00          0.21       88.93    0.89
  3    8400          0.00          0.11       88.91    0.89
  3    8600          0.00          0.23       88.86    0.89
  3    8800          0.00          0.15       88.80    0.89
  3    9000          0.00          0.11       88.95    0.89
  3    9200          0.00          0.30       88.90    0.89
  3    9400          0.00          0.11       89.11    0.89
  3    9600          0.00          0.12       89.14    0.89
  3    9800          0.00          0.12       89.09    0.89
  3   10000          0.00          0.16       88.95    0.89
  3   10200          0.00          0.17       89.01    0.89
  4   10400          0.00          0.10       89.07    0.89
  4   10600          0.00          0.12       89.14    0.89
  4   10800          0.00          0.12       89.15    0.89
  4   11000          0.00          0.11       89.09    0.89
  4   11200          0.00          0.13       89.03    0.89
  4   11400          0.00          0.09       89.11    0.89
  4   11600          0.00          0.11       89.28    0.89
  4   11800          0.00          0.18       89.15    0.89
  4   12000          0.00          0.14       89.33    0.89
  4   12200          0.00          0.09       89.22    0.89
  4   12400          0.00          0.15       89.22    0.89
  5   12600          0.00          0.10       89.08    0.89
  5   12800          0.00          0.11       89.17    0.89
  5   13000          0.00          0.15       89.24    0.89
  5   13200          0.00          0.12       89.20    0.89
  5   13400          0.00          0.12       89.08    0.89
  5   13600          0.00          0.15       89.18    0.89
<span class="ansi-green-fg">✔ Saved pipeline to output directory</span>
output-multiclass/model-last
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here's the py file for testing the multiclass classification model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> test_input_multiclass.py

<span class="kn">import</span> <span class="nn">spacy</span>
<span class="c1"># load the best model from training</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"output-multiclass/model-best"</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"type : 'quit' to exit"</span><span class="p">)</span>
<span class="c1"># predict the product category until someone writes quit</span>
<span class="k">while</span> <span class="n">text</span> <span class="o">!=</span> <span class="s2">"quit"</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"Please enter a review here: "</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">cats</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Writing test_input_multiclass.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Again, let's print out 10 reviews in <code>valid_data</code> for the purpose of testing.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> test_input_multiclass.py

<span class="kn">import</span> <span class="nn">spacy</span>
<span class="c1"># load the best model from training</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"/content/drive/MyDrive/Python/NLP/shopping_comments/spaCy-text-classification/spaCy-product-cat-model/model-best"</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"type : 'quit' to exit"</span><span class="p">)</span>
<span class="c1"># predict the product category until someone writes quit</span>
<span class="k">while</span> <span class="n">text</span> <span class="o">!=</span> <span class="s2">"quit"</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"Please enter a review here: "</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">cats</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Writing test_input_multiclass.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">valid_data</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[('和以前買的不一樣！以前用的特別滑！用的也少！這次買的不僅用的東西多！而且還頭皮癢！有頭屑！', '洗髮水'),
 ('不好意思我貨未收到，我想起訴你們！', '衣服'),
 ('寶貝收到了，是我想要的版型，質量十分好，這條褲子的顏色跟圖片上一樣，是我想要的顏色，總之，是一次很愉快的購物', '衣服'),
 ('一點也不甜不清脆，只能榨汁了。', '水果'),
 ('蘋果小，但味道不錯，給個好評吧', '水果'),
 ('平板收到，很滿意和想像的一樣，沒失望第一時間體驗中，稍後再評', '平板'),
 ('說好的樂視會員一年 送哪去了 差評', '平板'),
 ('相當完美啊 好東西', '平板'),
 ('連生產生日都沒有，真不知道是不是真的。', '洗髮水'),
 ('蘋果一如既往得好，脆、甜、水分足，推薦購買哦奧～', '水果')]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The model works as expected. I intentionally tested the ambiguous review, 這個牌子值得信賴 (This brand is trustworthy.), which could have been a review for tablets, clothing, or shampoo. And our model gave top three scores to precisely these three classes!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python test_input_multiclass.py
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2021-03-05 05:07:28.215017: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.11.0
type : 'quit' to exit
Please enter a review here: 和以前買的不一樣！以前用的特別滑！用的也少！這次買的不僅用的東西多！而且還頭皮癢！有頭屑！
{'平板': 2.058545214822516e-05, '水果': 1.1623805221461225e-05, '洗髮水': 0.9999675750732422, '衣服': 2.6233973926537146e-07, '酒店': 7.811570945648327e-09}
Please enter a review here: 蘋果小，但味道不錯，給個好評吧
{'平板': 0.0010689852060750127, '水果': 0.9964427351951599, '洗髮水': 0.00197225296869874, '衣服': 0.00019674153008963913, '酒店': 0.0003193040902260691}
Please enter a review here: 脆、甜、水分足，推薦購買哦奧～
{'平板': 0.00028378094430081546, '水果': 0.9972990155220032, '洗髮水': 0.0011949185281991959, '衣服': 0.0006593622965738177, '酒店': 0.0005628817598335445}
Please enter a review here: 收到，很滿意和想像的一樣，沒失望第一時間體驗中，稍後再評
{'平板': 0.5766726732254028, '水果': 0.07788817584514618, '洗髮水': 0.16239948570728302, '衣服': 0.16160377860069275, '酒店': 0.0214359350502491}
Please enter a review here: 連生產生日都沒有，真不知道是不是真的。
{'平板': 0.23529699444770813, '水果': 0.032520271837711334, '洗髮水': 0.6238041520118713, '衣服': 0.017157811671495438, '酒店': 0.09122073650360107}
Please enter a review here: 這個牌子值得信賴，
{'平板': 0.19572772085666656, '水果': 0.10571669787168503, '洗髮水': 0.362021267414093, '衣服': 0.29673027992248535, '酒店': 0.03980398178100586}
Please enter a review here: quit
{'平板': 0.25125113129615784, '水果': 0.061232421547174454, '洗髮水': 0.27915307879447937, '衣服': 0.12709283828735352, '酒店': 0.2812705338001251}
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python test_input_multiclass.py
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2021-03-16 10:14:45.823434: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.11.0
type : 'quit' to exit
Please enter a review here: 是蘋果，大家都想要
{'平板': 0.07115291804075241, '水果': 0.872447669506073, '洗髮水': 0.011495854705572128, '衣服': 0.027250811457633972, '酒店': 0.01765277236700058}
Please enter a review here: 是蘋果的，大家都想要
{'平板': 0.05921125411987305, '水果': 0.8904093503952026, '洗髮水': 0.01062779687345028, '衣服': 0.025291932746767998, '酒店': 0.014459758996963501}
Please enter a review here: 是蘋果的，大家都想要
{'平板': 0.05921125411987305, '水果': 0.8904093503952026, '洗髮水': 0.01062779687345028, '衣服': 0.025291932746767998, '酒店': 0.014459758996963501}
Please enter a review here: 是
{'平板': 0.23912471532821655, '水果': 0.11478321999311447, '洗髮水': 0.206477552652359, '衣服': 0.26159045100212097, '酒店': 0.17802411317825317}
Please enter a review here: 是蘋果的產品，大家都想要。
{'平板': 0.09895286709070206, '水果': 0.8691270351409912, '洗髮水': 0.016442863270640373, '衣服': 0.012551860883831978, '酒店': 0.002925291657447815}
Please enter a review here: 蘋果的產品，大家都想要。
{'平板': 0.1049538403749466, '水果': 0.865241289138794, '洗髮水': 0.014476561918854713, '衣服': 0.01276717334985733, '酒店': 0.0025611238088458776}
Please enter a review here: 蘋果的手機大家都想要。
{'平板': 0.7589152455329895, '水果': 0.208853617310524, '洗髮水': 0.0034141496289521456, '衣服': 0.013454959727823734, '酒店': 0.015362164005637169}
Please enter a review here: quit
{'平板': 0.25125113129615784, '水果': 0.061232421547174454, '洗髮水': 0.27915307879447937, '衣服': 0.12709283828735352, '酒店': 0.2812705338001251}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now I can rest assured and save the trained model to Google Drive.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="s2">"/content/output-multiclass/model-best"</span>
<span class="n">dest</span> <span class="o">=</span> <span class="s2">"/content/drive/MyDrive/Python/NLP/shopping_comments/spaCy-product-cat-model/"</span>
<span class="o">!</span>cp -R <span class="o">{</span>source<span class="o">}</span> <span class="o">{</span>dest<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Checking-model-performance">
<a class="anchor" href="#Checking-model-performance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checking model performance<a class="anchor-link" href="#Checking-model-performance"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I thought I'd have to write custom functions to evaluate the performance of our classification models. But it turns out that spaCy, our unfailingly considerate friend, has done it for us under the hood. Performance metrics are hidden in the <code>meta.json</code> file under the <code>model-best</code> directory. Here's the content of the <code>meta.json</code> file for our multiclass classification model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="n">meta_path</span> <span class="o">=</span> <span class="s2">"/content/drive/MyDrive/Python/NLP/shopping_comments/spaCy-text-classification/spaCy-product-cat-model/model-best/meta.json"</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
<span class="n">metrics</span>    
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'author': '',
 'components': ['tok2vec', 'textcat'],
 'description': '',
 'disabled': [],
 'email': '',
 'labels': {'textcat': ['平板', '水果', '洗髮水', '衣服', '酒店'], 'tok2vec': []},
 'lang': 'zh',
 'license': '',
 'name': 'pipeline',
 'performance': {'cats_f_per_type': {'平板': {'f': 0.8329853862,
    'p': 0.9140893471,
    'r': 0.7651006711},
   '水果': {'f': 0.9107981221, 'p': 0.9525368249, 'r': 0.8725637181},
   '洗髮水': {'f': 0.8430637386, 'p': 0.8827818284, 'r': 0.8067657611},
   '衣服': {'f': 0.8985658409, 'p': 0.9303455724, 'r': 0.868885527},
   '酒店': {'f': 0.9810741688, 'p': 0.9932677369, 'r': 0.9691763517}},
  'cats_macro_auc': 0.9846299582,
  'cats_macro_auc_per_type': 0.0,
  'cats_macro_f': 0.8932974513,
  'cats_macro_p': 0.9346042619,
  'cats_macro_r': 0.8564984058,
  'cats_micro_f': 0.8939148603,
  'cats_micro_p': 0.9357025697,
  'cats_micro_r': 0.8557,
  'cats_score': 0.8932974513,
  'cats_score_desc': 'macro F',
  'textcat_loss': 0.1365536493,
  'tok2vec_loss': 0.0},
 'pipeline': ['tok2vec', 'textcat'],
 'spacy_git_version': 'f4f46b617',
 'spacy_version': '&gt;=3.0.3,&lt;3.1.0',
 'url': '',
 'vectors': {'keys': 0, 'name': None, 'vectors': 0, 'width': 0},
 'version': '0.0.0'}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Specifically, values of the <code>performance</code> key are what we're looking for.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">performance</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">'performance'</span><span class="p">]</span>
<span class="n">performance</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'cats_f_per_type': {'平板': {'f': 0.8329853862,
   'p': 0.9140893471,
   'r': 0.7651006711},
  '水果': {'f': 0.9107981221, 'p': 0.9525368249, 'r': 0.8725637181},
  '洗髮水': {'f': 0.8430637386, 'p': 0.8827818284, 'r': 0.8067657611},
  '衣服': {'f': 0.8985658409, 'p': 0.9303455724, 'r': 0.868885527},
  '酒店': {'f': 0.9810741688, 'p': 0.9932677369, 'r': 0.9691763517}},
 'cats_macro_auc': 0.9846299582,
 'cats_macro_auc_per_type': 0.0,
 'cats_macro_f': 0.8932974513,
 'cats_macro_p': 0.9346042619,
 'cats_macro_r': 0.8564984058,
 'cats_micro_f': 0.8939148603,
 'cats_micro_p': 0.9357025697,
 'cats_micro_r': 0.8557,
 'cats_score': 0.8932974513,
 'cats_score_desc': 'macro F',
 'textcat_loss': 0.1365536493,
 'tok2vec_loss': 0.0}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's make a nice DataFrame object out of the metrics of the overall performance.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">score</span> <span class="o">=</span> <span class="n">performance</span><span class="p">[</span><span class="s1">'cats_score'</span><span class="p">]</span>
<span class="n">auc</span> <span class="o">=</span> <span class="n">performance</span><span class="p">[</span><span class="s1">'cats_macro_auc'</span><span class="p">]</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">performance</span><span class="p">[</span><span class="s1">'cats_macro_f'</span><span class="p">]</span>
<span class="n">precision</span> <span class="o">=</span> <span class="n">performance</span><span class="p">[</span><span class="s1">'cats_macro_p'</span><span class="p">]</span>
<span class="n">recall</span> <span class="o">=</span> <span class="n">performance</span><span class="p">[</span><span class="s1">'cats_macro_r'</span><span class="p">]</span>
<span class="n">overall_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'score'</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">'precision'</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span> <span class="s1">'recall'</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span> <span class="s1">'F1'</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span> <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc</span><span class="p">}</span>
<span class="n">overall_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">overall_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">overall_df</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>score</th>
      <th>precision</th>
      <th>recall</th>
      <th>F1</th>
      <th>AUC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.893297</td>
      <td>0.934604</td>
      <td>0.856498</td>
      <td>0.893297</td>
      <td>0.98463</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also break down the metrics into specific categories, which are saved as the values of the <code>cats_f_per_type</code> key of <code>performance</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">per_cat_dict</span> <span class="o">=</span> <span class="n">performance</span><span class="p">[</span><span class="s1">'cats_f_per_type'</span><span class="p">]</span>
<span class="n">per_cat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">per_cat_dict</span><span class="p">)</span>
<span class="n">per_cat_df</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>平板</th>
      <th>水果</th>
      <th>洗髮水</th>
      <th>衣服</th>
      <th>酒店</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>p</th>
      <td>0.914089</td>
      <td>0.952537</td>
      <td>0.882782</td>
      <td>0.930346</td>
      <td>0.993268</td>
    </tr>
    <tr>
      <th>r</th>
      <td>0.765101</td>
      <td>0.872564</td>
      <td>0.806766</td>
      <td>0.868886</td>
      <td>0.969176</td>
    </tr>
    <tr>
      <th>f</th>
      <td>0.832985</td>
      <td>0.910798</td>
      <td>0.843064</td>
      <td>0.898566</td>
      <td>0.981074</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Previously, I also used the <code>fasttext</code> library to train a multiclass classification model on the same dataset. Here're the values of the parameters I set up. And the overall accuracy is 0.886, which is pretty close to our spaCy model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">{</span><span class="s1">'dim'</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
 <span class="s1">'epoch'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
 <span class="s1">'loss'</span><span class="p">:</span> <span class="s1">'softmax'</span><span class="p">,</span>
 <span class="s1">'lr'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
 <span class="s1">'test_size'</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
 <span class="s1">'window'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
 <span class="s1">'wordNgrams'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And here's the breakdown for each category. One noticeable difference between the spaCy and fastText model is that the spaCy model has the highest scores in the HOTEL category (<code>酒店</code>) across all three metrics whereas the fastText model consistently performs the best in the TABLET category (<code>平板</code>) in terms of all three metrics.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>cat</th>
      <th>平板</th>
      <th>水果</th>
      <th>洗髮水</th>
      <th>衣服</th>
      <th>酒店</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>p</th>
      <td>0.976</td>
      <td>0.892</td>
      <td>0.851</td>
      <td>0.899</td>
      <td>0.816</td>
    </tr>
    <tr>
      <th>r</th>
      <td>0.972</td>
      <td>0.908</td>
      <td>0.832</td>
      <td>0.885</td>
      <td>0.836</td>
    </tr>
    <tr>
      <th>f</th>
      <td>0.974</td>
      <td>0.9</td>
      <td>0.841</td>
      <td>0.892</td>
      <td>0.825</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Recap">
<a class="anchor" href="#Recap" aria-hidden="true"><span class="octicon octicon-link"></span></a>Recap<a class="anchor-link" href="#Recap"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Like fastText, spaCy is good for training text classification models, and this task has become a no-brainer with the release of spaCy v3.0. Even in cases where both methods work equally well, spaCy still has an edge over fastText. That is, with spaCy you don't need to deal with text preprocessing or tokenization. So, watch this space-y!</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/blog.ai/spacy/text-classification/sentiment-analysis/customer-reviews/fasttext/facets/2021/03/12/Classifying-customer-reviews-with-spaCy-v3.html" hidden></a>
</article>

<script src="https://utteranc.es/client.js"
        repo="howard-haowen/blog.ai"
        issue-term="[ENTER TERM HERE]"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog.ai/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog.ai/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog.ai/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>AI through a linguist&#39;s looking glass</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/howard-haowen" title="howard-haowen"><svg class="svg-icon grey"><use xlink:href="/blog.ai/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/haowen-jiang-phd-16242074" title="haowen-jiang-phd-16242074"><svg class="svg-icon grey"><use xlink:href="/blog.ai/assets/minima-social-icons.svg#linkedin"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
